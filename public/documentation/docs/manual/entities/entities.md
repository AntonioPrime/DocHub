# Сущности(entities)

Метамодель DocHub можно расширять. Это позволяют делать кастомные сущности.

Предположим, что мы хотим описывать сценарии взаимодействия архитектурных компонентов. 
Для этого декларируем новую сущность - "interactions".

## Декларирование новой сущности

```yaml
entities:           # Здесь описываются кастомные сущности
  interactions:     # Идентификатор новой сущности. Обязательно.
    # Название сущности. Обязательно.
    title: Взаимодействия   
    # Описание сущности текст или ссылка на документ. Необязательно.
    description: >          
        Взаимодействия между компонентами
```

Данная запись сообщила DocHub, что в метамодели появилась новая сущность "interactions". 

Теперь, можно описать объект данной сущности.

```yaml
# Идентификатор сущности
interactions:
  # Идентификатор объекта
  dochub.user:
    title: Взаимодействия с пользователем
    triggers:
      - Просмотр архитектуры
    steps:
      - from: User
        to: DocHub
        value: Вход на портал
      - from: DocHub
        to: User
        value: Представление архитектурных артефактов
    results:
      - Информация о существующей архитектуре
```

В секции "interactions" находится произвольная структура. Ее образ и смысл полностью определяется задумкой автора.
DocHub, на этом этапе, ничего о ней не знает и делать не умеет.


## Схема объектов сущностей

Для того, чтобы DocHub мог контролировать структуру и наполнение объектов сущности "interactions", необходимо 
описать схему данных в специальном разделе "schema" с использованием [JSONSchema](https://json-schema.org/):

```yaml
entities:
  interactions:
    title: Взаимодействия
    description: >
      Взаимодействия между компонентами
    schema:
      # Секция "interactions" будет представлять из себя объект в понятии JSONSchema
      type: object
      # Идентификаторы его полей должны соответствовать паттерну структурированного идентификатора
      # состоящего из доменов разделенных точкой. Например: dochub.user
      # Фактически, объект будет реализовывать массив ключ-значение, где поле это ключ,
      # а его значение - объект сущности.
      patternProperties:
        "[a-zA-Z0-9_]*(\\.[a-zA-Z0-9_]*)*$": # Шаблон 
          type: object  # Взаимодействие будет объект
          properties:   # со следующей структурой
            icon:       # Идентификатор иконки
              title: Иконка   # Описание поля, которое помогает понять его смысл и выдается в подсказках
              type: string    # Идентификатор может быть любой строкой
              minLength: 2    # Но ее длина не должна быть меньше двух символов
            title:       # Наименование сценария
              title: Наименование
              type: string
              minLength: 5
            triggers:   # Перечень причин вызывающий данный сценарий
              title: События запускающие взаимодействие
              type: array
              minItems: 1
              items:
                type: string
                minLength: 5
            steps:        # Шаги сценария
              title: Описание взаимодействия
              type: array
              minItems: 1 # Минимум один шаг
              items:
                type: object
                properties:
                  from:   # Откуда делается шаг
                    title: От кого
                    type: string
                    minLength: 1
                  to:     # Куда
                    title: Кому
                    type: string
                    minLength: 1
                  value:  # Что в нем происходит
                    title: Что
                    type: string
                    minLength: 1
              # Сообщаем, что перечисленные поля обязательны
              required:
                - from
                - to
                - value
            results:      # Результаты данного взаимодействия
              title: Результаты взаимодействия
              type: array
              minItems: 1
              items:
                type: string
                minLength: 5
        # Сообщаем, что перечисленные поля обязательны
        required:
          - title
          - triggers
          - results
          - steps
```

Теперь, DocHub знает как должна быть описана структура в секции "interactions" и может подсказывать при вводе кода:

![Подсказки](images/suggests.png)

А также сообщать об ошибках:

![Ошибки](images/problems.png)

## Презентация объектов

Презентации позволяют генерировать представления объектов сущности.
Это могут быть диаграммы, vsg картинки, terraform код и т.п.

Для генерации используются [документы](/docs/dochub.docs). Вы можете использовать любой 
тип документа доступный в DocHub.

Для начала создадим карточку объекта. В ней будет отражаться диаграмма взаимодействия с использованием
[PlantUML](/docs/dochub.plantuml).

```yaml
entities:
    interactions:               
      ...
      presentations:            # Представления объектов сущности. Обязательно.
        blank:                  # Карточка объекта
          # Название представления
          title: Диаграмма взаимодействия
          # Параметры, которые требуются представлению в формате JSONSchema
          params:         
            type: object
            properties:
              id:
                type: string
            required:
              - id
          # Тип документа, который будет использоваться для представления
          type: plantuml
          # Шаблон, который будет использоваться для рендеринга документа
          template: templates/blank.puml
          # Источник данных для представления
          source: >       # Источник данных для рендера шаблона. Возвращает объект "interactions" по идентификатору переданному в параметрах.
              (
                  $lookup(interactions, $params.id)
              )
      ...
```
Этот код описывает презентацию "blank" - карточку объекта. Поле "title" содержит название презентации, 
которое будет выводиться пользователю. 

Поле "params" декларирует требований к передаваемым параметрам для генерации презентации в формате [JSONSchema](https://json-schema.org/).
Если параметры не будут удовлетворять схеме, будет выведена ошибка.

"type" определяет, какой тип документа будет использоваться для данного представления. Документ может
накладывать требования к матаданным. В данном случае, от типа документа зависят поля "template" и "source".

"template" содержит относительный путь к шаблону на языке [mustache](https://mustache.github.io/).
Подробнее о шаблонах можно узнать [здесь](/docs/dochub.templates). 

Файл шаблона (templates/blank.puml) содержит код:
```mustache
@startuml
{{#.}}
title {{title}}
{{#triggers}}
group {{#triggers}}{{.}}, {{/triggers}}
{{/triggers}}
    {{#steps}}
    "{{from}}" --> "{{to}}": {{value}}
    {{/steps}}
    {{#results}}
    note across: {{#results}}{{.}}, {{/results}}
    {{/results}}
{{#triggers}}
end
{{/triggers}}
{{/.}}
@enduml
```

Данные для него готовятся [JSONata](https://jsonata.org/) запросом содержащимся в поле "source".
В запросе, в переменной $params, будут доступны параметры, которе передаются презентации. Например,
если в параметре "id" будет передано значение "dochub.user", то запрос вернут следующую структуру:

```json
{
    "title": "Взаимодействия с пользователем",
    "triggers": [
        "Просмотр архитектуры"
    ],
    "steps": [
        {
            "from": "User",
            "to": "DocHub",
            "value": "Вход на портал"
        },
        {
            "from": "DocHub",
            "to": "User",
            "value": "Представление архитектурных артефактов"
        }
    ],
    "results": [
        "Информация о существующей архитектуре"
    ]
}
```
Это описание объекта, которое мы выполнили ранее. Эти данные будут переданы в шаблон и он синтезирует результат.
Теперь есть возможность увидеть результат работы представления. Для этого в markdown документ необходимо 
встроить представление нашего объекта. 

```markdown
![](@entity/interactions/blank?id=dochub.user)
```

Результатом станет диаграмма:

![](@entity/interactions/blank?id=dochub.user)

Аналогичным образом создается презентация "tree" для визуализации иерархии сценариев взаимодействия в виде дерева. 
В отличии от презентации "blank", параметры ей не требуются. 

Встраиваем ее в markdown документ:

```markdown
![](@entity/interactions/tree)
```

Получаем результат:
![](@entity/interactions/tree)

Полный исходный код можно посмотреть [здесь](/documentation/entities/interactions/entity.yaml).

## Встраивание в меню


[Далее](/docs/dochub.radar)
